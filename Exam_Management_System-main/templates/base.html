{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Exam Management System{% endblock %}</title>

    <!-- Google Fonts - Modern Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Font Awesome for legacy support -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom Modern Theme -->
    <link href="{% static 'css/theme.css' %}" rel="stylesheet">

    <!-- Three.js Library for 3D Models -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    {% block extra_css %}{% endblock %}

    <!-- 3D Loading Animation Styles -->
    <style>
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #loading-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-container {
            text-align: center;
        }

        #loading-3d {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
        }

        .loading-content {
            margin-top: 2rem;
        }

        .loading-message {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s ease-in-out;
            border-radius: 10px;
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- 3D Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-container">
            <div id="loading-3d"></div>
            <div class="loading-content">
                <div class="loading-message">Loading...</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar"></div>
                </div>
                <div class="loading-text">Please wait while we prepare your content</div>
            </div>
        </div>
    </div>

    <!-- Modern Sticky Navigation Bar -->
    <nav class="navbar navbar-expand-lg sticky-top fade-in" aria-label="Main navigation" style="perspective: 1200px;">
        <div class="container-fluid px-3 px-md-4">
            <!-- Brand -->
            <a class="navbar-brand fw-800 text-3d" href="{% url 'dashboard' %}" style="font-size: 1.35rem; font-weight: 800;">
                <i class="bi bi-mortarboard-fill me-2 icon-3d" style="color: var(--primary);"></i>
                <span>ExamHub</span>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Desktop Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center gap-2">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'dashboard' %}">
                                <i class="bi bi-speedometer2 me-1"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'ai_assistant:chat_list' %}">
                                <i class="bi bi-robot me-1"></i> AI Assistant
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'profile' %}">
                                <i class="bi bi-person-circle me-1"></i> Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link btn btn-ghost" data-bs-toggle="modal" data-bs-target="#supportModal">
                                <i class="bi bi-question-circle me-1"></i> Help
                            </button>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-primary btn-sm" href="{% url 'logout' %}">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="btn btn-outline-primary btn-sm" href="{% url 'login' %}">
                                Login
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-primary btn-sm" href="{% url 'register' %}">
                                Get Started
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
        <div class="offcanvas-header">
            <h5 id="mobileMenuLabel" class="offcanvas-title fw-700">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav">
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ai_assistant:chat_list' %}">AI Assistant</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'profile' %}">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'logout' %}">Logout</a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'register' %}">Register</a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1200">
        <div id="toast-container"></div>
    </div>

    <!-- Help & Support Modal -->
    <div class="modal fade" id="supportModal" tabindex="-1" aria-labelledby="supportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content float-3d">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title text-3d" id="supportModalLabel">
                        <i class="bi bi-question-circle me-2 spin-3d"></i> Help & Support
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Need assistance with the exam system?</p>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-file-earmark-text me-2 icon-3d" style="color: var(--primary);"></i>
                            Check the documentation
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-envelope me-2 icon-3d" style="color: var(--primary);"></i>
                            Contact the administrator
                        </li>
                        <li>
                            <i class="bi bi-chat-dots me-2 icon-3d" style="color: var(--primary);"></i>
                            Visit the support center
                        </li>
                    </ul>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary btn-3d" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="py-4 py-md-5">
        <div class="container-fluid px-3 px-md-4">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Modern Footer -->
    <footer class="border-top border-opacity-10 mt-5 py-4">
        <div class="container-fluid px-3 px-md-4">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <small class="text-muted">
                        &copy; 2025 <span class="text-gradient fw-700">ExamHub</span> - Exam Management System
                    </small>
                </div>
                <div class="col-md-6 text-center text-md-end mt-3 mt-md-0">
                    <small class="text-muted">
                        Made with <i class="bi bi-heart-fill" style="color: var(--accent);"></i> for better education
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modern Interaction Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeModernUI();
        });

        function initializeModernUI() {
            // Convert Django messages to modern toasts
            handleDjangoMessages();
            
            // Add ripple effect to buttons
            initializeRippleEffect();
            
            // Smooth animations on page load
            animateOnPageLoad();
            
            // Initialize form interactions
            initializeFormInteractions();
        }

        function handleDjangoMessages() {
            const container = document.getElementById('toast-container');
            {% if messages %}
                {% for message in messages %}
                    const toastEl = document.createElement('div');
                    const tagClass = getMessageTagClass('{{ message.tags }}');
                    toastEl.className = 'toast fade-in-up';
                    toastEl.setAttribute('role', 'alert');
                    toastEl.setAttribute('aria-live', 'assertive');
                    toastEl.setAttribute('aria-atomic', 'true');
                    
                    const icon = getMessageIcon('{{ message.tags }}');
                    toastEl.innerHTML = `
                        <div class="alert alert-{{ tagClass }} m-0 d-flex align-items-center">
                            <i class="bi ${icon} me-2"></i>
                            <div class="flex-grow-1">{{ message|escapejs }}</div>
                            <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`;
                    
                    container.appendChild(toastEl);
                    
                    // Auto-dismiss after 4 seconds
                    setTimeout(() => {
                        if (toastEl.parentElement) {
                            toastEl.remove();
                        }
                    }, 4000);
                {% endfor %}
            {% endif %}
        }

        function getMessageTagClass(tag) {
            const tagMap = {
                'success': 'success',
                'error': 'danger',
                'warning': 'warning',
                'info': 'info'
            };
            return tagMap[tag] || 'primary';
        }

        function getMessageIcon(tag) {
            const iconMap = {
                'success': 'bi-check-circle-fill',
                'error': 'bi-exclamation-circle-fill',
                'warning': 'bi-exclamation-triangle-fill',
                'info': 'bi-info-circle-fill'
            };
            return iconMap[tag] || 'bi-info-circle-fill';
        }

        function initializeRippleEffect() {
            const buttons = document.querySelectorAll('.btn, [role="button"]');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    if (this.querySelector('.ripple')) {
                        const ripple = this.querySelector('.ripple');
                        ripple.remove();
                    }

                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    ripple.style.cssText = `
                        position: absolute;
                        width: ${size}px;
                        height: ${size}px;
                        left: ${x}px;
                        top: ${y}px;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.6);
                        transform: scale(0);
                        animation: ripple-animation 600ms ease-out;
                        pointer-events: none;
                    `;

                    if (this.style.position === 'static') {
                        this.style.position = 'relative';
                    }
                    this.appendChild(ripple);
                });
            });
        }

        function animateOnPageLoad() {
            // Add fade-in animations to main content
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.style.opacity = '0';
                mainContent.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    mainContent.style.transition = 'all 600ms cubic-bezier(0.4, 0, 0.2, 1)';
                    mainContent.style.opacity = '1';
                    mainContent.style.transform = 'translateY(0)';
                }, 10);
            }

            // Stagger child animations
            const cards = document.querySelectorAll('.card, .stat-card, .auth-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 600ms cubic-bezier(0.4, 0, 0.2, 1)';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50 + index * 50);
            });
        }

        function initializeFormInteractions() {
            // Floating label animation
            const inputs = document.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.classList.add('is-focused');
                });
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.classList.remove('is-focused');
                    }
                });
                if (input.value) {
                    input.classList.add('is-focused');
                }
            });

            // Form validation feedback
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (!this.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    this.classList.add('was-validated');
                });
            });
        }

        // Add ripple animation keyframe
        if (!document.querySelector('style[data-ripple]')) {
            const style = document.createElement('style');
            style.setAttribute('data-ripple', 'true');
            style.textContent = `
                @keyframes ripple-animation {
                    to {
                        transform: scale(4);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Intersection Observer for lazy animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in-up');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        // Observe all cards and elements with animation classes
        document.querySelectorAll('[data-animate]').forEach(el => {
            observer.observe(el);
        });
    </script>

    <!-- 3D Models Script -->
    <script src="{% static 'js/3d-models.js' %}"></script>

    {% block extra_js %}{% endblock %}
</body>
</html>