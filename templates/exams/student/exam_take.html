{% extends 'base.html' %}
{% load static %}

{% block title %}Take Exam - Exam Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Exam Info Header -->
            <div class="card card-3d card-tilt mb-4">
                <div class="card-body bg-primary text-white rounded-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="mb-0"><i class="fas fa-book me-2"></i> {{ exam_schedule.question_paper.subject.name }}</h4>
                            <small>Exam Duration: {{ exam_schedule.question_paper.duration_minutes }} minutes</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <h5 class="mb-0">Marks: {{ exam_schedule.question_paper.total_marks }}</h5>
                            <small>Time Remaining: <span id="timer">90:00</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Exam Instructions -->
            <div class="alert alert-info mb-4">
                <h5><i class="fas fa-info-circle"></i> Instructions</h5>
                <p>{{ exam_schedule.question_paper.instructions|linebreaks }}</p>
                <ul>
                    <li>Please read each question carefully before answering</li>
                    <li>Select the most appropriate answer for multiple choice questions</li>
                    <li>You can review and change your answers before submitting</li>
                    <li>Your exam will be auto-submitted when time expires</li>
                </ul>
            </div>

            <!-- Exam Questions Form -->
            <form method="post" id="examForm" onsubmit="return confirmSubmit();">
                {% csrf_token %}

                {% for question in questions %}
                    <div class="card mb-3 card-3d card-tilt">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 d-flex justify-content-between align-items-center">
                                <span><span class="badge bg-primary">Question {{ forloop.counter }}</span></span>
                                <span class="text-muted">Marks: {{ question.marks }}</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><strong>{{ question.question_text }}</strong></p>

                            {% if question.question_type == 'mcq' %}
                                <!-- MCQ Options -->
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q{{ question.id }}" id="q{{ question.id }}_a" value="a">
                                    <label class="form-check-label" for="q{{ question.id }}_a">
                                        <strong>A.</strong> {{ question.option_a }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q{{ question.id }}" id="q{{ question.id }}_b" value="b">
                                    <label class="form-check-label" for="q{{ question.id }}_b">
                                        <strong>B.</strong> {{ question.option_b }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q{{ question.id }}" id="q{{ question.id }}_c" value="c">
                                    <label class="form-check-label" for="q{{ question.id }}_c">
                                        <strong>C.</strong> {{ question.option_c }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q{{ question.id }}" id="q{{ question.id }}_d" value="d">
                                    <label class="form-check-label" for="q{{ question.id }}_d">
                                        <strong>D.</strong> {{ question.option_d }}
                                    </label>
                                </div>
                            {% else %}
                                <!-- Descriptive Answer -->
                                <textarea class="form-control" name="q{{ question.id }}" rows="5" placeholder="Enter your answer here..."></textarea>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}

                <!-- Submit Button -->
                <div class="card mb-4 card-3d">
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-warning"></i> Once you submit, you cannot make any changes to your answers.
                        </div>
                        <button type="submit" class="btn btn-3d btn-lg w-100" aria-label="Submit Exam">
                            <i class="fas fa-check"></i> Submit Exam
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Timer functionality
    let remainingTime = 90 * 60; // 90 minutes in seconds
    
    function updateTimer() {
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        document.getElementById('timer').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        
        if (remainingTime <= 0) {
            document.getElementById('examForm').submit();
        }
        remainingTime--;
    }
    
    setInterval(updateTimer, 1000);
    
    function confirmSubmit() {
        return confirm('Are you sure you want to submit your exam? You cannot change your answers after submission.');
    }
</script>
{% endblock %}
